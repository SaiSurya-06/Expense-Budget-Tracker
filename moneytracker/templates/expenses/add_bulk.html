{% extends 'base.html' %}
{% load static %}

{% block content %}
<style>
    .main-content {
        padding: 0;
    }

    .bulk-container {
        max-width: 1200px;
        margin: 2rem auto;
        padding: 2rem;
        background: white;
        border-radius: 20px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.08);
        border: 1px solid #E5E7EB;
    }

    .bulk-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2rem;
        border-bottom: 1px solid #E5E7EB;
        padding-bottom: 1rem;
    }

    .bulk-title {
        font-size: 1.5rem;
        font-weight: 700;
        color: #1F2937;
    }

    .transaction-grid-header {
        display: grid;
        grid-template-columns: 100px 140px 1fr 150px 150px 120px 40px;
        gap: 1rem;
        padding: 0.5rem 1rem;
        background: #F1F5F9;
        border-radius: 8px;
        margin-bottom: 0.5rem;
        font-weight: 600;
        font-size: 0.875rem;
        color: #4B5563;
    }

    .transaction-row {
        display: grid;
        grid-template-columns: 100px 140px 1fr 150px 150px 120px 40px;
        gap: 1rem;
        align-items: start;
        padding: 1rem;
        background: white;
        border: 1px solid #E5E7EB;
        border-radius: 12px;
        margin-bottom: 0.75rem;
        transition: all 0.2s ease;
    }

    .transaction-row:hover {
        border-color: #CBD5E1;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
    }

    .form-input-sm {
        width: 100%;
        padding: 0.625rem;
        border: 1px solid #E5E7EB;
        border-radius: 8px;
        font-size: 0.9rem;
        color: #1F2937;
        background: #F9FAFB;
    }

    .form-input-sm:focus {
        border-color: #2563EB;
        outline: none;
        background: white;
        box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.1);
    }

    .btn {
        padding: 0.75rem 1.5rem;
        border-radius: 10px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        border: none;
    }

    .btn-primary {
        background: #2563EB;
        color: white;
    }

    .btn-primary:hover {
        background: #1D4ED8;
    }

    .btn-secondary {
        background: #E5E7EB;
        color: #374151;
        text-decoration: none;
        display: inline-block;
    }

    .btn-secondary:hover {
        background: #D1D5DB;
    }

    .btn-add {
        background: #10B981;
        color: white;
    }

    .btn-add:hover {
        background: #059669;
    }

    .remove-btn {
        color: #9CA3AF;
        cursor: pointer;
        font-size: 1.5rem;
        line-height: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        width: 30px;
        height: 38px;
        transition: color 0.2s;
    }

    .remove-btn:hover {
        color: #DC2626;
    }

    .error-msg {
        grid-column: 1 / -1;
        color: #DC2626;
        font-size: 0.8rem;
        margin-top: 0.25rem;
        display: none;
    }

    @media (max-width: 1024px) {
        .transaction-grid-header {
            display: none;
        }

        .transaction-row {
            grid-template-columns: 1fr;
            gap: 0.5rem;
            position: relative;
            padding-right: 3rem;
        }

        .remove-btn {
            position: absolute;
            top: 1rem;
            right: 1rem;
        }
    }
</style>

<div class="main-content">
    <div class="bulk-container">
        <div class="bulk-header">
            <h2 class="bulk-title">Add Multiple Transactions</h2>
            <a href="{% url 'transactions' %}" class="btn btn-secondary">Back to Transactions</a>
        </div>

        <form id="bulkForm">
            {% csrf_token %}

            <div class="transaction-grid-header">
                <div>Type</div>
                <div>Date</div>
                <div>Description / Source</div>
                <div>Category</div>
                <div>Account</div>
                <div>Amount</div>
                <div></div>
            </div>

            <div id="transaction-list">
                <!-- Rows injected here -->
            </div>

            <div style="margin-top: 2rem; display: flex; gap: 1rem; border-top: 1px solid #E5E7EB; padding-top: 2rem;">
                <button type="button" class="btn btn-add" onclick="addRow()">+ Add Another Row</button>
                <button type="submit" class="btn btn-primary" style="margin-left: auto; min-width: 200px;">Save All
                    Transactions</button>
            </div>
        </form>
    </div>
</div>

<script>
    const categoriesExpense = {{ categories_expense_json| safe }};
    const categoriesIncome = {{ categories_income_json| safe }};
    const accounts = {{ accounts_json| safe }};

    function addRow() {
        const container = document.getElementById('transaction-list');
        const row = document.createElement('div');
        row.className = 'transaction-row';

        let accOptions = accounts.map(a => `<option value="${a.id}">${a.name}</option>`).join('');

        row.innerHTML = `
            <div>
                <select class="form-input-sm type-select" onchange="updateCategories(this)">
                    <option value="expense">Expense</option>
                    <option value="income">Income</option>
                </select>
            </div>
            <div>
                <input type="date" class="form-input-sm date-input" required>
            </div>
            <div>
                <input type="text" class="form-input-sm desc-input" placeholder="Description" required>
            </div>
            <div>
                <select class="form-input-sm cat-select" required></select>
            </div>
            <div>
                <select class="form-input-sm acc-select" required>${accOptions}</select>
            </div>
            <div>
                <input type="number" step="0.01" class="form-input-sm amount-input" placeholder="0.00" required>
            </div>
            <div class="remove-btn" onclick="removeRow(this)" title="Remove">Ã—</div>
            <div class="error-msg"></div>
        `;

        container.appendChild(row);

        // Default to today
        const today = new Date().toISOString().split('T')[0];
        row.querySelector('.date-input').value = today;

        updateCategories(row.querySelector('.type-select'));
    }

    function removeRow(btn) {
        const list = document.getElementById('transaction-list');
        if (list.children.length > 1) {
            btn.closest('.transaction-row').remove();
        } else {
            // Clear values instead if only one row
            const row = btn.closest('.transaction-row');
            row.querySelector('.desc-input').value = '';
            row.querySelector('.amount-input').value = '';
        }
    }

    function updateCategories(select) {
        const row = select.closest('.transaction-row');
        const catSelect = row.querySelector('.cat-select');
        const type = select.value;

        // Save current selection if exists
        const currentVal = catSelect.value;

        let options = '';
        const list = type === 'expense' ? categoriesExpense : categoriesIncome;

        if (list.length === 0) {
            options = '<option value="">No categories</option>';
        } else {
            list.forEach(c => {
                options += `<option value="${c.id}">${c.name}</option>`;
            });
        }

        catSelect.innerHTML = options;
    }

    // Init with 3 rows
    addRow();
    addRow();
    addRow();

    const form = document.getElementById('bulkForm');
    form.addEventListener('submit', function (e) {
        e.preventDefault();

        const rows = document.querySelectorAll('.transaction-row');
        const transactions = [];
        let globalError = false;

        rows.forEach((row, i) => {
            const err = row.querySelector('.error-msg');
            err.textContent = '';
            err.style.display = 'none';

            const type = row.querySelector('.type-select').value;
            const date = row.querySelector('.date-input').value;
            const description = row.querySelector('.desc-input').value.trim();
            const category_id = row.querySelector('.cat-select').value;
            const account_id = row.querySelector('.acc-select').value;
            const amount = row.querySelector('.amount-input').value;

            // Skip empty rows if logic desires, but user said "validation...". 
            // We enforce required on inputs, so browser handles emptiness mostly.
            // But 'required' might be bypassed.

            if (description && amount) {
                transactions.push({
                    type, date, description, category_id, account_id, amount
                });
            }
        });

        if (transactions.length === 0) {
            alert("Please enter at least one transaction.");
            return;
        }

        const btn = form.querySelector('button[type="submit"]');
        const originalText = btn.textContent;
        btn.disabled = true;
        btn.textContent = 'Saving...';

        fetch('{% url "add_bulk_transactions" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({ transactions })
        })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    window.location.href = "{% url 'transactions' %}";
                } else {
                    btn.disabled = false;
                    btn.textContent = originalText;

                    if (data.details) {
                        alert("Validation Error:\n" + data.details.join('\n'));
                    } else {
                        alert("Error: " + data.error);
                    }
                }
            })
            .catch(err => {
                btn.disabled = false;
                btn.textContent = originalText;
                console.error(err);
                alert("Network or Server Error");
            });
    });
</script>
{% endblock %}