{% extends 'base.html' %}
{% load humanize %}

{% block content %}
<div class="layout-container" style="padding: 2rem 0;">
    <!-- Header Section -->
    <div class="d-flex justify-between align-center mb-4" style="flex-wrap: wrap; gap: 1.5rem;">
        <div>
            <h1
                style="font-size: 2rem; margin-bottom: 0.5rem; font-weight: 800; background: var(--primary-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">
                Manage Budgets
            </h1>
            <p class="text-muted" style="font-size: 1rem;">
                Track your monthly spending limits and stay on top of your finances.
            </p>
        </div>
        <a href="{% url 'budget_create' %}" class="btn btn-primary"
            style="background: var(--primary-gradient); color: var(--primary-gradient); border: none; padding: 0.75rem 1.5rem; border-radius: 12px; font-weight: 600; box-shadow: 0 4px 6px -1px rgba(79, 70, 229, 0.2);">
            <span>+</span> Create New Budget
        </a>
    </div>

    {% if messages %}
    {% for message in messages %}
    <div class="card p-4 mb-4 text-{{ message.tags }}"
        style="border-radius: 12px; border-left: 4px solid {% if message.tags == 'error' %}var(--danger-500){% else %}var(--success-500){% endif %}; background: white;">
        {{ message }}
    </div>
    {% endfor %}
    {% endif %}

    {% if budgets %}
    <div class="budget-grid">
        {% for b in budgets %}
        <div class="card budget-card">
            <div class="card-header d-flex justify-between align-start mb-4">
                <div>
                    <h3 class="card-title"
                        style="font-size: 1.5rem; font-weight: 700; color: var(--text-primary); margin-bottom: 0.25rem;">
                        {{ b.month|date:"F Y" }}
                    </h3>
                    <span class="badge"
                        style="background: var(--primary-50); color: var(--primary-700); font-weight: 600; font-size: 0.8rem; padding: 0.25rem 0.75rem; border-radius: 20px;">
                        Monthly Plan
                    </span>
                </div>
                <div class="d-flex gap-2">
                    <a href="{% url 'budget_edit' b.month|date:'Y-m' %}" class="btn btn-icon" title="Edit"
                        style="color: var(--text-secondary); padding: 0.5rem; border-radius: 8px; transition: all 0.2s;">
                        ‚úèÔ∏è
                    </a>
                    <form action="{% url 'budget_delete' b.month|date:'Y-m' %}" method="post"
                        onsubmit="return confirm('Are you sure you want to delete this budget plan?');"
                        style="margin: 0;">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-icon" title="Delete"
                            style="color: var(--danger-500); padding: 0.5rem; border-radius: 8px; transition: all 0.2s; background: transparent; border: none; cursor: pointer;">
                            üóëÔ∏è
                        </button>
                    </form>
                </div>
            </div>

            <!-- Global Limit -->
            <div class="mb-4 p-3" style="background: #f9fafb; border-radius: 12px;">
                <div class="d-flex justify-between mb-2 align-center">
                    <span style="font-weight: 600; color: var(--text-secondary); font-size: 0.9rem;">Total Budget</span>
                    {% if b.global %}
                    <span
                        style="font-weight: 700; font-size: 1rem; color: {% if b.global.is_exceeded %}var(--danger-600){% else %}var(--text-primary){% endif %};">
                        ‚Çπ{{ b.global.spent|intcomma }} <span class="text-muted" style="font-weight: 400;">/ ‚Çπ{{
                            b.global.limit|intcomma }}</span>
                    </span>
                    {% else %}
                    <span class="text-muted" style="font-size: 0.9rem;">No Limit Set</span>
                    {% endif %}
                </div>
                {% if b.global %}
                <div class="progress-track">
                    <div class="progress-fill"
                        style="width: {{ b.global.percent|floatformat:0 }}%; 
                               background: {% if b.global.is_exceeded %}var(--danger-500){% else %}var(--primary-gradient){% endif %};">
                    </div>
                </div>
                {% endif %}
            </div>

            <!-- Categories -->
            <div>
                <h4 style="font-size: 1rem; font-weight: 600; margin-bottom: 1rem; color: var(--text-primary);">
                    Category Limits ({{ b.categories|length }})
                </h4>
                {% if b.categories %}
                <div class="custom-scrollbar" style="max-height: 240px; overflow-y: auto; padding-right: 0.5rem;">
                    {% for cat in b.categories %}
                    <div class="mb-3">
                        <div class="d-flex justify-between mb-1" style="font-size: 0.9rem;">
                            <span style="font-weight: 500;">{{ cat.category.name }}</span>
                            <span
                                style="font-weight: 600; font-size: 0.85rem; color: {% if cat.is_exceeded %}var(--danger-600){% else %}var(--text-secondary){% endif %};">
                                {{ cat.spent|intcomma }} / {{ cat.limit|intcomma }}
                            </span>
                        </div>
                        <div class="progress-track small">
                            <div class="progress-fill"
                                style="width: {{ cat.percent|floatformat:0 }}%; 
                                       background: {% if cat.is_exceeded %}var(--danger-500){% else %}var(--success-500){% endif %};">
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="text-center p-4" style="border: 1px dashed #e5e7eb; border-radius: 12px;">
                    <p class="text-muted text-sm m-0">No category limits defined.</p>
                </div>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="card text-center p-5" style="border-radius: 20px; box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.05);">
        <div style="font-size: 4rem; margin-bottom: 1rem;">üìä</div>
        <h3 style="font-size: 1.5rem; font-weight: 700; margin-bottom: 0.5rem;">No budgets found</h3>
        <p class="text-muted mb-4">Start taking control of your finances by creating a budget plan for this month.</p>
        <a href="{% url 'budget_create' %}" class="btn btn-primary"
            style="background: var(--primary-gradient); color: var(--primary-gradient); padding: 0.75rem 2rem; border-radius: 12px;">
            Create First Budget
        </a>
    </div>
    {% endif %}
</div>

<style>
    .budget-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(380px, 1fr));
        gap: 2rem;
    }

    .budget-card {
        background: white;
        border-radius: 20px;
        padding: 1.5rem;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
        border: 1px solid rgba(0, 0, 0, 0.02);
        transition: transform 0.2s, box-shadow 0.2s;
    }

    .budget-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 12px 20px -5px rgba(0, 0, 0, 0.1);
    }

    .progress-track {
        height: 8px;
        background: #f3f4f6;
        border-radius: 4px;
        overflow: hidden;
    }

    .progress-track.small {
        height: 6px;
    }

    .progress-fill {
        height: 100%;
        border-radius: 4px;
        transition: width 1s ease-in-out;
    }

    .btn-icon:hover {
        background: #f3f4f6 !important;
    }

    .custom-scrollbar::-webkit-scrollbar {
        width: 6px;
    }

    .custom-scrollbar::-webkit-scrollbar-track {
        background: transparent;
    }

    .custom-scrollbar::-webkit-scrollbar-thumb {
        background-color: #e5e7eb;
        border-radius: 20px;
    }

    @media (max-width: 768px) {
        .budget-grid {
            grid-template-columns: 1fr;
        }
    }
</style>
{% endblock %}